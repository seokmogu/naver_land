# EC2 Ubuntu 22.04 í™˜ê²½ê³¼ ë™ì¼í•œ Docker ì´ë¯¸ì§€
FROM ubuntu:22.04

# ì‹œê°„ëŒ€ ì„¤ì • (í•œêµ­ ì‹œê°„)
ENV TZ=Asia/Seoul
RUN ln -snf /usr/share/zoneinfo/$TZ /etc/localtime && echo $TZ > /etc/timezone

# ë¹„ëŒ€í™”ì‹ ì„¤ì¹˜ ëª¨ë“œ
ENV DEBIAN_FRONTEND=noninteractive

# EC2ì™€ ë™ì¼í•œ íŒ¨í‚¤ì§€ ì„¤ì¹˜ (aws_auto_deploy.shì˜ user-dataì™€ ë™ì¼)
RUN apt-get update && apt-get upgrade -y && \
    apt-get install -y \
    python3 \
    python3-pip \
    python3-venv \
    git \
    curl \
    wget \
    vim \
    nano \
    htop \
    jq \
    ca-certificates \
    bc \
    && rm -rf /var/lib/apt/lists/*

# Playwright ì˜ì¡´ì„± (í† í° ìˆ˜ì§‘ìš©ë§Œ - ì‹¤ì œë¡œëŠ” ê±°ì˜ ì‚¬ìš© ì•ˆí•¨)
RUN apt-get update && apt-get install -y \
    libnss3 \
    libnspr4 \
    libatk1.0-0 \
    libatk-bridge2.0-0 \
    libcups2 \
    libdrm2 \
    libdbus-1-3 \
    libatspi2.0-0 \
    libx11-6 \
    libxcomposite1 \
    libxdamage1 \
    libxext6 \
    libxfixes3 \
    libxrandr2 \
    libgbm1 \
    libxcb1 \
    libxkbcommon0 \
    libpango-1.0-0 \
    libcairo2 \
    libasound2 \
    && rm -rf /var/lib/apt/lists/*

# ì‚¬ìš©ì ìƒì„± (EC2 ubuntu ì‚¬ìš©ìì™€ ë™ì¼)
RUN useradd -m -s /bin/bash ubuntu && \
    echo 'ubuntu ALL=(ALL) NOPASSWD:ALL' >> /etc/sudoers

# ubuntu ì‚¬ìš©ìë¡œ ì „í™˜
USER ubuntu
WORKDIR /home/ubuntu

# naver_land í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ ìƒì„±
RUN mkdir -p naver_land

# ì‘ì—… ë””ë ‰í† ë¦¬ ì„¤ì •
WORKDIR /home/ubuntu/naver_land

# Python ê°€ìƒí™˜ê²½ ìƒì„± (EC2ì™€ ë™ì¼)
RUN python3 -m venv venv

# ê°€ìƒí™˜ê²½ í™œì„±í™”ë¥¼ ìœ„í•œ alias ì„¤ì •
RUN echo 'alias activate="source ~/naver_land/venv/bin/activate"' >> ~/.bashrc

# pip ì—…ê·¸ë ˆì´ë“œ
RUN /home/ubuntu/naver_land/venv/bin/pip install --upgrade pip

# requirements.txt ë³µì‚¬ ë° ì„¤ì¹˜
COPY --chown=ubuntu:ubuntu requirements.txt .
RUN /home/ubuntu/naver_land/venv/bin/pip install -r requirements.txt

# í”„ë¡œì íŠ¸ íŒŒì¼ ë³µì‚¬ (EC2 ë™ê¸°í™”ì™€ ë™ì¼í•œ êµ¬ì¡°)
COPY --chown=ubuntu:ubuntu collectors/ ./collectors/
COPY --chown=ubuntu:ubuntu deploy_scripts/ ./deploy_scripts/

# ë¡œê·¸, ê²°ê³¼, ë°±ì—… ë””ë ‰í† ë¦¬ ìƒì„± (EC2ì™€ ë™ì¼)
RUN mkdir -p logs results collectors/results

# ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
USER root
RUN chmod +x /home/ubuntu/naver_land/deploy_scripts/*.sh
RUN chmod +x /home/ubuntu/naver_land/collectors/*.sh 2>/dev/null || true
USER ubuntu

# í™˜ê²½ë³€ìˆ˜ ì„¤ì •
ENV PYTHONUNBUFFERED=1
ENV PATH="/home/ubuntu/naver_land/venv/bin:$PATH"

# .env íŒŒì¼ ë³µì‚¬ (ìˆë‹¤ë©´)
COPY --chown=ubuntu:ubuntu .env .env 2>/dev/null || true

# ì‹œì‘ ìŠ¤í¬ë¦½íŠ¸
COPY --chown=ubuntu:ubuntu deploy_scripts/docker_test_setup.sh ./
RUN chmod +x docker_test_setup.sh

# ê¸°ë³¸ ì‹¤í–‰ ëª…ë ¹ (bash ì‹¤í–‰í•˜ì—¬ ëŒ€í™”í˜• ëª¨ë“œ)
CMD ["/bin/bash", "-c", "echo 'ğŸ³ EC2 í…ŒìŠ¤íŠ¸ í™˜ê²½ ì¤€ë¹„ ì™„ë£Œ!' && echo 'ì‚¬ìš©ë²•:' && echo '  source venv/bin/activate  # ê°€ìƒí™˜ê²½ í™œì„±í™”' && echo '  python3 collectors/fixed_naver_collector.py  # ìˆ˜ì§‘ê¸° í…ŒìŠ¤íŠ¸' && echo '' && /bin/bash"]