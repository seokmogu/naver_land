# EC2 Ubuntu 22.04 환경과 동일한 Docker 이미지
FROM ubuntu:22.04

# 시간대 설정 (한국 시간)
ENV TZ=Asia/Seoul
RUN ln -snf /usr/share/zoneinfo/$TZ /etc/localtime && echo $TZ > /etc/timezone

# 비대화식 설치 모드
ENV DEBIAN_FRONTEND=noninteractive

# EC2와 동일한 패키지 설치 (aws_auto_deploy.sh의 user-data와 동일)
RUN apt-get update && apt-get upgrade -y && \
    apt-get install -y \
    python3 \
    python3-pip \
    python3-venv \
    git \
    curl \
    wget \
    vim \
    nano \
    htop \
    jq \
    ca-certificates \
    bc \
    && rm -rf /var/lib/apt/lists/*

# Playwright 의존성 (토큰 수집용만 - 실제로는 거의 사용 안함)
RUN apt-get update && apt-get install -y \
    libnss3 \
    libnspr4 \
    libatk1.0-0 \
    libatk-bridge2.0-0 \
    libcups2 \
    libdrm2 \
    libdbus-1-3 \
    libatspi2.0-0 \
    libx11-6 \
    libxcomposite1 \
    libxdamage1 \
    libxext6 \
    libxfixes3 \
    libxrandr2 \
    libgbm1 \
    libxcb1 \
    libxkbcommon0 \
    libpango-1.0-0 \
    libcairo2 \
    libasound2 \
    && rm -rf /var/lib/apt/lists/*

# 사용자 생성 (EC2 ubuntu 사용자와 동일)
RUN useradd -m -s /bin/bash ubuntu && \
    echo 'ubuntu ALL=(ALL) NOPASSWD:ALL' >> /etc/sudoers

# ubuntu 사용자로 전환
USER ubuntu
WORKDIR /home/ubuntu

# naver_land 프로젝트 디렉토리 생성
RUN mkdir -p naver_land

# 작업 디렉토리 설정
WORKDIR /home/ubuntu/naver_land

# Python 가상환경 생성 (EC2와 동일)
RUN python3 -m venv venv

# 가상환경 활성화를 위한 alias 설정
RUN echo 'alias activate="source ~/naver_land/venv/bin/activate"' >> ~/.bashrc

# pip 업그레이드
RUN /home/ubuntu/naver_land/venv/bin/pip install --upgrade pip

# requirements.txt 복사 및 설치
COPY --chown=ubuntu:ubuntu requirements.txt .
RUN /home/ubuntu/naver_land/venv/bin/pip install -r requirements.txt

# 프로젝트 파일 복사 (EC2 동기화와 동일한 구조)
COPY --chown=ubuntu:ubuntu collectors/ ./collectors/
COPY --chown=ubuntu:ubuntu deploy_scripts/ ./deploy_scripts/

# 로그, 결과, 백업 디렉토리 생성 (EC2와 동일)
RUN mkdir -p logs results collectors/results

# 스크립트 실행 권한 부여
USER root
RUN chmod +x /home/ubuntu/naver_land/deploy_scripts/*.sh
RUN chmod +x /home/ubuntu/naver_land/collectors/*.sh 2>/dev/null || true
USER ubuntu

# 환경변수 설정
ENV PYTHONUNBUFFERED=1
ENV PATH="/home/ubuntu/naver_land/venv/bin:$PATH"

# .env 파일 복사 (있다면)
COPY --chown=ubuntu:ubuntu .env .env 2>/dev/null || true

# 시작 스크립트
COPY --chown=ubuntu:ubuntu deploy_scripts/docker_test_setup.sh ./
RUN chmod +x docker_test_setup.sh

# 기본 실행 명령 (bash 실행하여 대화형 모드)
CMD ["/bin/bash", "-c", "echo '🐳 EC2 테스트 환경 준비 완료!' && echo '사용법:' && echo '  source venv/bin/activate  # 가상환경 활성화' && echo '  python3 collectors/fixed_naver_collector.py  # 수집기 테스트' && echo '' && /bin/bash"]