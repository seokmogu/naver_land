# EC2 안전 테스트 가이드

## 배포 후 실행 단계

### 1단계: EC2 접속
```bash
ssh naver-ec2
```

### 2단계: 작업 디렉토리로 이동  
```bash
cd /home/ubuntu/naver_land/collectors
```

### 3단계: 안전 테스트 실행
```bash
./ec2_safe_test.sh
```

## 테스트 단계별 설명

### 🔍 1️⃣ 사전 점검
- ✅ 필수 파일 존재 확인
- ✅ Python 환경 확인  
- ✅ 의존성 패키지 확인

### 📊 2️⃣ 데이터베이스 상태 확인
- ✅ emergency_recovery.py 실행
- ✅ 현재 85,107개 매물 상태 확인
- ✅ DB 연결 및 무결성 검증

### 🧪 3️⃣ 안전한 수집 테스트 (테스트 모드)
- ✅ 강남구 신사동 (1168010100) 테스트
- ✅ 최대 2페이지만 수집
- ✅ **DB에 저장하지 않고** 테스트만 실행
- ✅ 수집 품질 및 안전성 검증

### 💾 4️⃣ 품질 검증 후 실제 저장 테스트 (선택적)
- ❓ 사용자 확인 후 실행 (y/N 선택)
- ✅ 실제 DB에 소량 저장 테스트
- ⚠️ 기존 85,107개 매물은 **절대 삭제되지 않음**
- ✅ 안전 모드로 동작 확인

### 🛡️ 5️⃣ 안전성 재확인
- ✅ 저장 후 DB 상태 재점검
- ✅ 기존 매물 보호 확인
- ✅ 새로운 매물 정상 추가 확인

## 예상 테스트 결과

```
🛡️ EC2 안전한 수집기 테스트 시작
===============================================

1️⃣ 사전 점검
----------------------------------------
[INFO] 필수 파일 존재 확인...
[SUCCESS] ✓ emergency_recovery.py
[SUCCESS] ✓ final_safe_collector.py
[SUCCESS] ✓ completely_safe_collector.py
[SUCCESS] ✓ json_to_db_converter.py
[SUCCESS] ✓ supabase_client.py
[SUCCESS] ✓ config.json

[INFO] Python 환경 확인...
[SUCCESS] ✓ Python 3.x.x

[INFO] Python 패키지 확인...
[SUCCESS] ✓ 필수 패키지 설치됨

2️⃣ 데이터베이스 상태 확인
----------------------------------------
[INFO] 응급 복구 시스템으로 현재 상태 확인...

🏥 응급 데이터 복구 시스템
===========================================
📊 현재 DB 상태:
   - 총 매물 수: 85,107개
   - 마지막 업데이트: 2024-08-27
   - DB 연결: 정상
   - 무결성: 확인됨

✅ 데이터베이스 상태 양호

3️⃣ 안전한 수집 테스트 (테스트 모드)
----------------------------------------
[INFO] 테스트 지역: 1168010100 (강남구 신사동)
[INFO] DB 저장하지 않고 테스트만 실행...

🔍 네이버 부동산 안전 수집기 (테스트 모드)
===========================================
📍 수집 지역: 1168010100 (강남구 신사동)
📄 최대 페이지: 2
🧪 테스트 모드: DB 저장하지 않음

페이지 1/2 수집 중... ✅ (50개 매물)
페이지 2/2 수집 중... ✅ (47개 매물)

📊 수집 결과:
   - 총 97개 매물 수집
   - 품질 검증: 통과
   - 중복 제거: 정상
   - 데이터 형식: 유효

⚠️ 테스트 모드: DB에 저장하지 않음

[SUCCESS] 테스트 모드 수집 완료

4️⃣ 품질 검증 후 실제 저장 테스트
----------------------------------------
품질이 충분하다면 실제 DB 저장을 테스트하시겠습니까? (y/N): y

[INFO] 실제 DB 저장 테스트 시작...
[WARNING] ⚠️ 기존 매물은 삭제되지 않습니다 (안전 모드)

🔍 네이버 부동산 안전 수집기 (실제 저장)
===========================================
📍 수집 지역: 1168010100 (강남구 신사동)  
📄 최대 페이지: 2
💾 실제 저장 모드: 안전한 DB 저장

페이지 1/2 수집 중... ✅ (50개 매물)
  └─ 새 매물 35개, 업데이트 15개
페이지 2/2 수집 중... ✅ (47개 매물)
  └─ 새 매물 32개, 업데이트 15개

💾 DB 저장 중...
  ✅ 67개 새 매물 추가
  ✅ 30개 기존 매물 업데이트
  ✅ 기존 85,107개 매물 보호됨

[SUCCESS] 실제 저장 테스트 완료

5️⃣ 안전성 재확인
----------------------------------------
[INFO] 저장 후 데이터베이스 상태 재확인...

🏥 응급 데이터 복구 시스템
===========================================
📊 현재 DB 상태:
   - 총 매물 수: 85,174개 (+67개)
   - 마지막 업데이트: 2024-08-27
   - DB 연결: 정상
   - 무결성: 확인됨

✅ 기존 85,107개 매물 모두 보호됨
✅ 67개 새 매물 정상 추가됨

6️⃣ 테스트 완료 요약
----------------------------------------
[SUCCESS] 모든 테스트가 완료되었습니다!
[INFO] ✅ 사전 점검 통과
[INFO] ✅ 데이터베이스 연결 확인
[INFO] ✅ 안전한 수집 테스트 통과
[INFO] ✅ 실제 저장 테스트 통과
[INFO] ✅ 안전성 재확인 완료

[SUCCESS] 🎉 EC2 안전한 수집기 테스트 성공!

다음 단계:
  1. 정기 수집을 위한 cron 설정
  2. 모니터링 시스템 구축
  3. 백업 및 복구 절차 수립
```

## 중요 안전 장치 확인사항

### ✅ 85,107개 기존 매물 보호 확인
- 기존 매물은 **절대 삭제되지 않음**
- `safe_mode=True`로 동작
- 삭제 작업 완전 비활성화

### ✅ 단계적 안전 검증
1. 테스트 모드 먼저 실행 (DB 저장 안함)
2. 사용자 확인 후 실제 저장
3. 소량 테스트로 안전성 확인
4. 저장 후 즉시 무결성 재검증

### ✅ 응급 복구 시스템 대기
- `emergency_recovery.py` 언제든 실행 가능
- DB 상태 실시간 모니터링
- 문제 발생시 즉시 대응 가능

## 문제 발생시 대응

### 테스트 실패시
```bash
# 응급 복구로 상태 확인
python3 emergency_recovery.py

# 로그 확인
tail -f /var/log/naver_collector.log
```

### SSH 연결 문제시
```bash
# 로컬에서 연결 테스트
ssh -v naver-ec2

# EC2 상태 확인 (AWS 콘솔)
```